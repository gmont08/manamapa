<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa Manabí – Manabiteando</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #000;
    }

    .leaflet-container {
      background: #000 !important;
    }

    .leaflet-control-attribution {
      display: none !important;
    }

    /* Tarjeta del popup (la nube grande) */
    .leaflet-popup-content-wrapper {
      border-radius: 28px !important;
      padding: 0 !important;
      background: rgba(255,255,255,0.94) !important;
      box-shadow: 0 14px 28px rgba(0,0,0,0.55);
      border: 1px solid rgba(220,220,220,0.9);
    }

    .leaflet-popup-content {
      margin: 0 !important;
      padding: 16px 20px 18px 20px !important;
      text-align: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
                   "Segoe UI", sans-serif;
    }

    .titulo-popup {
      font-size: 24px;
      font-weight: 800;
      color: #111;
      line-height: 1.15;
      margin-bottom: 6px;
    }

    .subtitulo-popup {
      font-size: 18px;
      color: #444;
      line-height: 1.25;
    }

    /* Quitar borde negro/blanco al hacer clic en el polígono */
    .leaflet-interactive:focus,
    .leaflet-interactive:focus-visible {
      outline: none !important;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const isMobile = window.innerWidth < 700;

    const map = L.map("map", {
      zoomControl: true,
      attributionControl: false
    }).setView([-0.9, -80.3], 8);

    // Fondo “vacío” para que solo se vea Manabí
    L.tileLayer("", {}).addTo(map);

    // --------- UTILIDADES ---------

    function normalizarNombre(texto) {
      if (!texto) return "";
      return texto
        .toString()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    // Parroquias rurales por cantón (basado en tu Excel)
    const ruralesPorCanton = {
      "24 de mayo": [
        "bellavista",
        "noboa"
      ],
      "bolivar": [
        "membrillo",
        "quiroga"
      ],
      "chone": [
        "boyaca",
        "canuto",
        "chibunga",
        "convento",
        "eloy alfaro",
        "ricaurte",
        "san antonio"
      ],
      "el carmen": [
        "paraiso (la 14)",
        "san pedro de suma",
        "santa maria",
        "wilfrido loor moreira"
      ],
      "flavio alfaro": [
        "san francisco de novillo",
        "zapallo jarry"
      ],
      "jipijapa": [
        "el anegado",
        "julcuy",
        "la america",
        "la union",
        "membrillal",
        "pedro pablo gomez",
        "puerto de cayo"
      ],
      "manta": [
        "san lorenzo",
        "santa marianita"
      ],
      "montecristi": [
        "la pila"
      ],
      "pajan": [
        "campozano",
        "cascol",
        "guale",
        "lascano"
      ],
      "pedernales": [
        "10 de agosto",
        "atahualpa",
        "cojimies"
      ],
      "pichincha": [
        "barraganete",
        "san sebastian"
      ],
      "portoviejo": [
        "abdon calderon",
        "alajuela",
        "churijos",
        "crucita",
        "pueblo nuevo",
        "rio chico",
        "san placido"
      ],
      "puerto lopez": [
        "machalilla",
        "salango"
      ],
      "san vicente": [
        "canoa"
      ],
      "santa ana": [
        "ayacucho",
        "honorato vasquez",
        "la union",
        "san pablo de pueblo nuevo"
      ],
      "sucre": [
        "charapoto",
        "san isidro"
      ],
      "tosagua": [
        "angel pedro giler",
        "san jose de bachillero"
      ]
    };

    // Parroquias URBANAS cuyo nombre NO coincide con el del cantón
    const urbanasEspeciales = {
      "sucre": ["bahia de caraquez"],
      "bolivar": ["calceta"],
      "24 de mayo": ["sucre"]
    };

    function esParroquiaRural(props) {
      const c = normalizarNombre(props.CANTON);
      const p = normalizarNombre(props.PARROQUIA);
      const lista = ruralesPorCanton[c] || [];
      return lista.includes(p);
    }

    function esParroquiaUrbana(props) {
      const c = normalizarNombre(props.CANTON);
      const p = normalizarNombre(props.PARROQUIA);

      if (esParroquiaRural(props)) return false;

      const especiales = urbanasEspeciales[c] || [];
      if (especiales.includes(p)) return true;

      // Regla general: parroquia urbana si se llama igual que el cantón
      if (p === c) return true;

      return false;
    }

    // Limpia el nombre de la parroquia y aplica correcciones
    function formatearNombreParroquia(nombreOriginal) {
      if (!nombreOriginal) return "";

      // quitamos cualquier cosa entre paréntesis (Cab en Eloy Alfaro, etc.)
      let base = nombreOriginal.split("(")[0].trim();

      // caso especial Puerto de Cayo -> Pto. Cayo
      if (normalizarNombre(base) === "puerto de cayo") {
        return "Pto. Cayo";
      }

      return base; // conserva mayúsculas/acentos originales
    }

    // Aquí podrías marcar parroquias “logradas” en el futuro
    const parroquiasCompletadas = []; // por ahora vacío

    // --------- CARGA DEL GEOJSON ---------

    fetch("parroquias_manabi.geojson")
      .then(res => res.json())
      .then(data => {
        const manabiLayer = L.geoJSON(data, {
          style: feature => ({
            color: "#555",
            weight: 1,
            fillColor: parroquiasCompletadas.includes(feature.properties.CODIGO)
                        ? "#c8f7c5"   // verde suave si está “logrado”
                        : "#f0f0f0",
            fillOpacity: 0.97
          }),

          onEachFeature: (feature, layer) => {
            const p = feature.properties;

            let tituloHTML = "";
            let subtituloHTML = "";

            if (esParroquiaRural(p)) {
              // PARROQUIA RURAL
              const nombreParr = formatearNombreParroquia(p.PARROQUIA);
              tituloHTML = `${nombreParr} (P.R.)`;
              subtituloHTML = p.CANTON;
            } else if (esParroquiaUrbana(p)) {
              // ZONA URBANA
              tituloHTML = p.CANTON;
              subtituloHTML = "Zona Urbana";
            } else {
              // Fallback: parroquia no clasificada, mostramos tal cual
              const nombreParr = formatearNombreParroquia(p.PARROQUIA);
              tituloHTML = nombreParr;
              subtituloHTML = p.CANTON;
            }

            const popupHTML = `
              <div class="titulo-popup">${tituloHTML}</div>
              <div class="subtitulo-popup">${subtituloHTML}</div>
            `;

            layer.bindPopup(popupHTML, {
              closeButton: false,
              offset: [0, -5],
              autoPanPaddingTopLeft: [40, 40],
              autoPanPaddingBottomRight: [40, 40]
            });

            // Hover: aclarar la zona
            layer.on("mouseover", e => {
              e.target.setStyle({
                fillColor: "#ffffff",
                fillOpacity: 1
              });
            });

            layer.on("mouseout", e => {
              manabiLayer.resetStyle(e.target);
            });
          }
        }).addTo(map);

        // Centrar el mapa a Manabí
        map.fitBounds(manabiLayer.getBounds(), {
          padding: isMobile ? [10, 10] : [35, 35]
        });

        // Sombra 3D suave al contorno completo
        setTimeout(() => {
          const svg = document.querySelector(".leaflet-overlay-pane svg");
          if (svg) {
            svg.style.filter = "drop-shadow(0px 12px 14px rgba(0,0,0,0.85))";
          }
        }, 300);
      });
  </script>
</body>
</html>
