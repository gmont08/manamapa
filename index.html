<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa ManabÃ­ â€“ Manabiteando</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #000;
    }

    .leaflet-container {
      background: #000 !important;
    }

    .leaflet-control-attribution {
      display: none !important;
    }

    /* Tarjeta del popup */
    .leaflet-popup-content-wrapper {
      border-radius: 28px !important;
      padding: 0 !important;
      background: rgba(255,255,255,0.94) !important;
      box-shadow: 0 14px 28px rgba(0,0,0,0.55);
      border: 1px solid rgba(220,220,220,0.9);
    }

    .leaflet-popup-content {
      margin: 0 !important;
      padding: 16px 20px 18px 20px !important;
      text-align: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
                  "Segoe UI", sans-serif;
    }

    .titulo-popup {
      font-size: 24px;
      font-weight: 800;
      color: #111;
      line-height: 1.15;
      margin-bottom: 6px;
    }

    .subtitulo-popup {
      font-size: 18px;
      color: #444;
      line-height: 1.25;
    }

    .leaflet-interactive:focus,
    .leaflet-interactive:focus-visible {
      outline: none !important;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const isMobile = window.innerWidth < 700;

    const map = L.map("map", {
      zoomControl: true,
      attributionControl: false
    }).setView([-0.9, -80.3], 8);

    L.tileLayer("", {}).addTo(map);

    // AquÃ­ tu fetch sin modificar
    fetch("parroquias_manabi.geojson")
      .then(res => res.json())
      .then(data => {
        const manabiLayer = L.geoJSON(data, {
          style: feature => ({
            color: "#555",
            weight: 1,
            fillColor: "#f0f0f0",
            fillOpacity: 0.97
          }),

          /* ðŸ”¥ðŸ”¥ NUEVO onEachFeature PEGADO AQUÃ ðŸ”¥ðŸ”¥ */
          onEachFeature: (feature, layer) => {
            const p = feature.properties;

            const codigo = String(p.CODIGO || "").trim();
            const canton = (p.CANTON || "").trim();
            let parroquia = (p.PARROQUIA || "").trim();

            // 1) Limpiar parÃ©ntesis
            let parroquiaBase = parroquia.replace(/\s*\(.*?\)\s*/g, "").trim();

            // 2) Ajustes especiales
            const reemplazos = {
              "Puerto Cayo": "Pto. Cayo",
              "America": "AmÃ©rica",
              "San Fco. De Novillo": "San Fco. Novillo",
              "Angel Pedro Giler": "Ãngel Pedro Giler"
            };

            Object.keys(reemplazos).forEach((clave) => {
              if (parroquiaBase.toLowerCase() === clave.toLowerCase()) {
                parroquiaBase = reemplazos[clave];
              }
            });

            // 3) Reglas por CODIGO
            const excepcionesRurales = new Set(["130550"]);
            const terminaEn50 = codigo.endsWith("50");
            const esZonaUrbana = terminaEn50 && !excepcionesRurales.has(codigo);
            const esRural = !esZonaUrbana;

            let tituloHTML = "";
            let subtituloHTML = "";

            if (esZonaUrbana) {
              tituloHTML = canton;
              subtituloHTML = "Zona Urbana";
            } else if (esRural) {
              tituloHTML = `${parroquiaBase} (P.R.)`;
              subtituloHTML = canton;
            }

            const popupHTML = `
              <div class="titulo-popup">${tituloHTML}</div>
              <div class="subtitulo-popup">${subtituloHTML}</div>
            `;

            layer.bindPopup(popupHTML, {
              closeButton: false,
              offset: [0, -5],
              autoPanPaddingTopLeft: [40, 40],
              autoPanPaddingBottomRight: [40, 40]
            });

            layer.on("mouseover", (e) => {
              e.target.setStyle({
                fillColor: "#ffffff",
                fillOpacity: 1
              });
            });

            layer.on("mouseout", (e) => {
              e.target.setStyle({
                fillColor: "#f0f0f0",
                fillOpacity: 0.97
              });
            });
          }
        }).addTo(map);

        map.fitBounds(manabiLayer.getBounds(), {
          padding: isMobile ? [10, 10] : [35, 35]
        });

        setTimeout(() => {
          const svg = document.querySelector(".leaflet-overlay-pane svg");
          if (svg) {
            svg.style.filter = "drop-shadow(0px 12px 14px rgba(0,0,0,0.85))";
          }
        }, 300);
      });
  </script>
</body>
</html>

